<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>Content Auth Demo</title>
  <style>
    body { font-family: sans-serif; max-width: 480px; margin: 2rem auto; }
    input, button { width: 100%; padding: 0.6rem; margin-bottom: 0.8rem; }
    pre { background: #f5f5f5; padding: 1rem; min-height: 120px; }
    .message { padding: 0.8rem; margin: 0.5rem 0; border-radius: 4px; }
    .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
  </style>
</head>
<body>
  <h1>Content Auth Demo</h1>

  <section>
    <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
    <input id="reg-email" placeholder="Email" type="email">
    <input id="reg-name" placeholder="–ò–º—è">
    <input id="reg-password" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
    <button type="button" onclick="register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
    <div id="reg-message"></div>
  </section>

  <section>
    <h2>–õ–æ–≥–∏–Ω</h2>
    <input id="login-email" placeholder="Email" type="email">
    <input id="login-password" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
    <button type="button" onclick="login()">–í–æ–π—Ç–∏</button>
    <div id="login-message"></div>
  </section>

  <section>
    <h2>–ü—Ä–æ—Ñ–∏–ª—å</h2>
    <div id="profile-info" class="info message" style="display: none;">
      –¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω. –ù–∞–∂–º–∏—Ç–µ "–ü–æ–ª—É—á–∏—Ç—å /me" –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è.
    </div>
    <button type="button" onclick="getMe()">–ü–æ–ª—É—á–∏—Ç—å /me</button>
    <button type="button" onclick="logout()">–í—ã–π—Ç–∏</button>
    <pre id="output">–ó–¥–µ—Å—å –±—É–¥—É—Ç –æ—Ç–≤–µ—Ç—ã API</pre>
  </section>

  <script>
    const API_BASE = "http://127.0.0.1:8000/api/v1";
    let token = null;

    function showMessage(elementId, message, type = 'info') {
      const element = document.getElementById(elementId);
      element.innerHTML = `<div class="message ${type}">${message}</div>`;
    }

    async function register(event) {
      // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ª—é–±–æ–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
      if (event) event.preventDefault();
      
      const email = document.getElementById("reg-email").value;
      const name = document.getElementById("reg-name").value;
      const password = document.getElementById("reg-password").value;

      // –û—á–∏—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¢–û–õ–¨–ö–û –≤ —Ä–∞–∑–¥–µ–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
      document.getElementById("reg-message").innerHTML = '';

      if (!email || !name || !password) {
        showMessage('reg-message', '‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
        return false; // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –¥–∞–ª—å–Ω–µ–π—à–µ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
      }

      try {
        const payload = { email, full_name: name, password };
        const res = await fetch(`${API_BASE}/register`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        
        const data = await res.json();
        
        if (res.ok) {
          showMessage('reg-message', '‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏.', 'success');
          // –û—á–∏—â–∞–µ–º –ø–æ–ª—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
          document.getElementById("reg-email").value = '';
          document.getElementById("reg-name").value = '';
          document.getElementById("reg-password").value = '';
        } else {
          showMessage('reg-message', `‚ùå –û—à–∏–±–∫–∞: ${data.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`, 'error');
        }
        show(data);
      } catch (error) {
        showMessage('reg-message', '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
        show({ error: error.message });
      }
      
      return false; // –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º false —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã
    }

    async function login(event) {
      if (event) event.preventDefault();
      
      const email = document.getElementById("login-email").value;
      const password = document.getElementById("login-password").value;

      // –û—á–∏—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¢–û–õ–¨–ö–û –≤ —Ä–∞–∑–¥–µ–ª–µ –ª–æ–≥–∏–Ω–∞
      document.getElementById("login-message").innerHTML = '';

      if (!email || !password) {
        showMessage('login-message', '‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å', 'error');
        return false;
      }

      try {
        const params = new URLSearchParams();
        params.append("username", email);
        params.append("password", password);

        const res = await fetch(`${API_BASE}/login`, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: params
        });
        
        const data = await res.json();
        
        if (res.ok) {
          token = data.access_token;
          showMessage('login-message', '‚úÖ –í—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω! –¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω.', 'success');
          document.getElementById("profile-info").style.display = 'block';
          // –û—á–∏—â–∞–µ–º –ø–æ–ª—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—Ö–æ–¥–∞
          document.getElementById("login-email").value = '';
          document.getElementById("login-password").value = '';
        } else {
          showMessage('login-message', `‚ùå –û—à–∏–±–∫–∞: ${data.detail || '–ù–µ–≤–µ—Ä–Ω—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ'}`, 'error');
        }
        show(data);
      } catch (error) {
        showMessage('login-message', '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
        show({ error: error.message });
      }
      
      return false;
    }

    async function getMe() {
      if (!token) {
        showMessage('login-message', '‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –≤—Ö–æ–¥', 'error');
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/me`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        
        const data = await res.json();
        
        if (res.ok) {
          showMessage('login-message', '‚úÖ –î–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—É—á–µ–Ω—ã', 'success');
        } else {
          showMessage('login-message', `‚ùå –û—à–∏–±–∫–∞: ${data.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`, 'error');
        }
        show(data);
      } catch (error) {
        showMessage('login-message', '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
        show({ error: error.message });
      }
    }

    function logout() {
      token = null;
      document.getElementById("profile-info").style.display = 'none';
      showMessage('login-message', 'üîì –í—ã—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω. –¢–æ–∫–µ–Ω –æ—á–∏—â–µ–Ω.', 'info');
      show("–¢–æ–∫–µ–Ω –æ—á–∏—â–µ–Ω –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ.");
    }

    function show(content) {
      document.getElementById("output").textContent = typeof content === "string"
        ? content
        : JSON.stringify(content, null, 2);
    }

    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã –ø–æ Enter
    document.addEventListener('keypress', function(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
      }
    });

    // –û—á–∏—â–∞–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById("reg-message").innerHTML = '';
      document.getElementById("login-message").innerHTML = '';
    });
  </script>
</body>
</html>